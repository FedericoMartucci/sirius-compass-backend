# PROJECT CONTEXT: Sirius Compass

## 1. Product Vision & User Persona
**Product:** Sirius Compass is an **Engineering Intelligence Platform** designed to audit and visualize software development lifecycles.
**Target Audience:** Project Managers (PMs) and Technical Leaders at **Sirius Software**.
**Value Proposition:**
* Resolves lack of visibility in heterogeneous projects (GitHub + Linear/Trello).
* Provides objective metrics ("Who is blocked?", "Velocity Trends") without micromanagement.
* Offers automatic mentoring feedback to developers based on actual code vs. requirements.
* **Delivery:** Accessed via a "Push" mechanism (Weekly Static Reports) and a "Pull" mechanism (Interactive Analytic Chat).

## 2. Tech Stack & Standards
* **Backend:** Python 3.11+, FastAPI (Async).
* **AI/Orchestration:** LangGraph (Stateful Multi-Agent Workflows), LangChain Core.
* **Database:** SQLModel (SQLAlchemy wrapper) with SQLite (MVP).
* **Frontend:** Next.js + Vercel AI SDK (handles UI streaming).
* **External APIs:** PyGithub (GitHub Adapter), Requests/GraphQL (Linear Adapter).
* **Coding Standards:**
    * **Code/Comments:** STRICTLY **ENGLISH**.
    * **LLM Output/User Facing Text:** STRICTLY **SPANISH** (Espa√±ol).
    * **Pattern:** Clean Architecture (Adapters, Services, Core Domain).

## 3. Core Architecture: The "Dual-Graph" Pattern
The system is split into two distinct LangGraph workflows to separate "Heavy Processing" from "Interactive Chat".

### A. The Analyst Graph (ETL & Reasoning) - *The "Sherlock" Engine*
* **File:** `app/core/agents/analyst_graph.py`
* **Type:** Batch Processing (Background Task).
* **Flow:**
    1.  **Ingest Node (Parallel):** Fetches GitHub Commits/PRs and Linear Tickets simultaneously using `asyncio.gather`. Uses `lookback_days` (default 720 for legacy analysis).
    2.  **Analyst Node (Logic):**
        * **Smart Context:** Prioritizes Linear Tickets and relevant Code to perform the "Sherlock" cross-reference (Ticket Requirements vs. Code Implementation).
        * **Scoring (RAG):** Evaluates Code Quality and Security using vector-stored "Sirius Standards" (Pinecone).
        * **Guardrails:** Automatically filters output to ensure NO sensitive data (PII, Secrets) leaks into the generated text.
    3.  **Reporter Node:** Generates a structured `DeveloperReport`.
    4.  **Writer Node:** Persists the report and raw activities to the SQL Database.

### B. The Chat Graph (Conversational Agent) - *The Assistant*
* **File:** `app/core/agents/chat_graph.py`
* **Type:** Persistent Chatbot (Request/Response with Streaming).
* **Flow:** Router Pattern.
* **Logic:**
    * Receives user query.
    * Decides whether to answer directly (greeting) or use **Tools**.
    * **Tools (`app/tools/db_reader.py`):**
        * `get_latest_audit_report`: Reads summarized high-level reports from SQL.
        * `get_developer_activity`: Deep dives into specific `Activity` rows.
    * **Memory:** Uses `MemorySaver` checkpointer to maintain thread history.
    * **Streaming:** The API response MUST be streamed (SSE) to allow the Frontend to display tokens as they are generated.

## 4. User Interface & Integration Scope
The Backend supports a UI with three core modules:
1.  **Configuration Dashboard:**
    * PMs input API Keys for GitHub and Linear.
    * Keys are securely handled to fetch data for specific Projects/Repositories.
2.  **Analytic Chat:**
    * A "ChatGPT-like" interface.
    * **Multimodality:** The AI responds with text AND can trigger dynamic chart rendering (e.g., Velocity Charts) on the frontend.
3.  **Reports View:**
    * Displays the static "Weekly Reports" generated by the Analyst Graph (Markdown + Traffic Light System).

## 5. Data Domain (`app/core/models/domain.py` & `database/models.py`)
We map raw API data to a Unified Domain Model before saving to SQL.

* **`UnifiedActivity`:**
    * `type`: COMMIT, PR_MERGE, TICKET.
    * `source_platform`: "github" | "linear".
    * `story_points`: Integer (from Linear).
* **`AnalysisReport`:** Stores the LLM generated audit (Quality Score 1-10, Feedback text).
* **`Repository`:** Parent entity.
* **Critical Implementation Detail:** `models.py` uses `__table_args__ = {"extend_existing": True}` to support `uvicorn --reload` without registry conflicts.

## 6. Business Rules & Guardrails
1.  **Ticket vs. Code Alignment:** The core value is detecting if the Code matches the Ticket. Discrepancies are "Red Flags".
2.  **Security & Privacy (CRITICAL):**
    * **Input:** Hardcoded secrets (.env, keys) or PII logging found in code must be flagged as critical security issues.
    * **Output:** The LLM MUST NOT repeat or output the actual secrets or PII in the final report. It should only reference "Sensitive data found in file X".
3.  **Language Consistency:** Detect "Spanglish" (mixed English/Spanish code).
4.  **Short-Circuiting:** If ingestion returns 0 activities, the Analyst Node stops immediately to save tokens.

## 7. Current File Structure
```text
/app
  /adapters       # GitHub (PyGithub) and Linear (GraphQL) clients
  /api            # FastAPI Routes (Server.py, Schemas) - Handles SSE Streaming
  /core
    /agents       # LangGraph definitions (nodes.py, state.py, graphs)
    /database     # SQLModel setup
    /models       # Domain Pydantic models
  /services       # Business logic (Sync, Charts)
  /tools          # LangChain tools for the Chat Graph